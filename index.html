<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ù„Ù‡Ø§</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ù„Ù‡Ø§">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --card: #1a1a26;
    --accent: #c9a96e;
    --accent2: #e8c99a;
    --text: #f0ead6;
    --muted: #6b6580;
    --border: rgba(201,169,110,0.15);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Tajawal', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Background texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 60% 50% at 50% 0%, rgba(201,169,110,0.06) 0%, transparent 70%),
      radial-gradient(ellipse 40% 30% at 80% 80%, rgba(180,140,90,0.04) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; max-width: 480px; margin: 0 auto; padding-bottom: 80px; }

  /* Header */
  .header {
    text-align: center;
    padding: 48px 24px 32px;
    position: relative;
  }
  .header::after {
    content: '';
    position: absolute;
    bottom: 0; left: 50%; transform: translateX(-50%);
    width: 60px; height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }
  .header .ornament {
    font-size: 24px;
    letter-spacing: 8px;
    color: var(--accent);
    opacity: 0.6;
    margin-bottom: 12px;
  }
  .header h1 {
    font-size: 38px;
    font-weight: 300;
    letter-spacing: 4px;
    color: var(--accent2);
    margin-bottom: 6px;
  }
  .header p {
    font-size: 13px;
    color: var(--muted);
    font-weight: 300;
    letter-spacing: 1px;
  }
  #counter {
    display: inline-block;
    margin-top: 16px;
    padding: 6px 16px;
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 12px;
    color: var(--accent);
    letter-spacing: 1px;
  }

  /* Tabs */
  .tabs {
    display: flex;
    margin: 28px 20px 0;
    background: var(--surface);
    border-radius: 12px;
    padding: 4px;
    border: 1px solid var(--border);
  }
  .tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    font-size: 13px;
    font-family: 'Tajawal', sans-serif;
    border: none;
    background: none;
    color: var(--muted);
    cursor: pointer;
    border-radius: 9px;
    transition: all 0.25s;
  }
  .tab.active {
    background: var(--card);
    color: var(--accent2);
    box-shadow: 0 2px 8px rgba(0,0,0,0.4);
  }

  /* Views */
  .view { display: none; padding: 20px; }
  .view.active { display: block; }

  /* Capture View */
  .camera-box {
    position: relative;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    aspect-ratio: 3/4;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px;
  }
  #video {
    width: 100%; height: 100%;
    object-fit: cover;
    display: none;
    transform: scaleX(-1);
  }
  #canvas { display: none; }
  #preview {
    width: 100%; height: 100%;
    object-fit: cover;
    display: none;
    border-radius: 16px;
  }
  .camera-placeholder {
    text-align: center;
    color: var(--muted);
  }
  .camera-placeholder .icon { font-size: 48px; margin-bottom: 12px; opacity: 0.4; }
  .camera-placeholder p { font-size: 14px; }

  .camera-overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }
  .corner {
    position: absolute;
    width: 20px; height: 20px;
    border-color: var(--accent);
    border-style: solid;
    opacity: 0.5;
  }
  .corner.tl { top: 16px; right: 16px; border-width: 2px 0 0 2px; border-radius: 0 0 0 0; }
  .corner.tr { top: 16px; left: 16px; border-width: 2px 2px 0 0; }
  .corner.bl { bottom: 16px; right: 16px; border-width: 0 0 2px 2px; }
  .corner.br { bottom: 16px; left: 16px; border-width: 0 2px 2px 0; }

  /* Buttons */
  .btn-primary {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #1a1000;
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-family: 'Tajawal', sans-serif;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.25s;
    letter-spacing: 1px;
  }
  .btn-primary:active { transform: scale(0.97); opacity: 0.9; }

  .btn-secondary {
    width: 100%;
    padding: 13px;
    background: var(--surface);
    color: var(--accent);
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 14px;
    font-family: 'Tajawal', sans-serif;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .btn-secondary:active { opacity: 0.7; }

  /* Mood selector */
  .mood-row {
    display: flex;
    gap: 8px;
    margin: 12px 0;
    flex-wrap: wrap;
  }
  .mood-chip {
    padding: 7px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 12px;
    font-family: 'Tajawal', sans-serif;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .mood-chip.selected {
    background: rgba(201,169,110,0.15);
    border-color: var(--accent);
    color: var(--accent2);
  }

  /* Note input */
  .note-input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    color: var(--text);
    font-size: 14px;
    font-family: 'Tajawal', sans-serif;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
    margin: 12px 0;
    line-height: 1.6;
  }
  .note-input:focus { border-color: rgba(201,169,110,0.4); }
  .note-input::placeholder { color: var(--muted); }

  label.field-label {
    font-size: 12px;
    color: var(--muted);
    display: block;
    margin-bottom: 6px;
    letter-spacing: 1px;
  }

  /* Timeline entries */
  .entry-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 20px;
    animation: fadeUp 0.4s ease forwards;
  }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .entry-img {
    width: 100%;
    aspect-ratio: 3/4;
    object-fit: cover;
    display: block;
  }
  .entry-info {
    padding: 16px;
  }
  .entry-date {
    font-size: 11px;
    color: var(--accent);
    letter-spacing: 1px;
    margin-bottom: 6px;
  }
  .entry-mood {
    display: inline-block;
    padding: 3px 10px;
    background: rgba(201,169,110,0.1);
    border-radius: 10px;
    font-size: 11px;
    color: var(--accent2);
    margin-bottom: 8px;
  }
  .entry-note {
    font-size: 14px;
    color: var(--text);
    line-height: 1.7;
    opacity: 0.85;
  }
  .entry-delete {
    background: none;
    border: none;
    color: var(--muted);
    font-size: 11px;
    cursor: pointer;
    margin-top: 10px;
    padding: 4px 0;
    font-family: 'Tajawal', sans-serif;
    opacity: 0.5;
  }
  .entry-delete:active { opacity: 1; color: #e07070; }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--muted);
  }
  .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
  .empty-state p { font-size: 14px; line-height: 1.8; }

  /* Bottom nav */
  .bottom-bar {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    justify-content: center;
  }
  .bottom-bar-inner {
    max-width: 480px;
    width: 100%;
    background: rgba(18,18,26,0.9);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex;
    padding: 8px 16px 16px;
    gap: 4px;
  }
  .nav-btn {
    flex: 1;
    padding: 10px;
    background: none;
    border: none;
    color: var(--muted);
    font-size: 10px;
    font-family: 'Tajawal', sans-serif;
    cursor: pointer;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
  }
  .nav-btn .nav-icon { font-size: 20px; }
  .nav-btn.active { color: var(--accent2); }
  .nav-btn.active .nav-icon-wrap {
    background: rgba(201,169,110,0.12);
    border-radius: 10px;
    padding: 6px 14px;
  }

  .toast {
    position: fixed;
    bottom: 90px;
    left: 50%; transform: translateX(-50%);
    background: var(--accent);
    color: #1a1000;
    padding: 12px 24px;
    border-radius: 24px;
    font-size: 13px;
    font-family: 'Tajawal', sans-serif;
    font-weight: 700;
    z-index: 200;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    white-space: nowrap;
  }
  .toast.show { opacity: 1; }

  /* Stats */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 20px;
  }
  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px 16px;
    text-align: center;
  }
  .stat-num {
    font-size: 36px;
    font-weight: 300;
    color: var(--accent2);
    line-height: 1;
    margin-bottom: 6px;
  }
  .stat-label {
    font-size: 11px;
    color: var(--muted);
    letter-spacing: 1px;
  }
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <div class="ornament">â€” âœ¦ â€”</div>
    <h1>Ù„ÙÙ€Ù‡ÙÙ€Ø§</h1>
    <p>Ù„Ø­Ø¸Ø§ØªÙƒ Ù‚Ø¨Ù„ Ø£Ù† ØªÙ„ØªÙ‚ÙŠÙ‡Ø§</p>
    <div id="counter">Ù  Ù„Ø­Ø¸Ø© Ù…Ø­ÙÙˆØ¸Ø©</div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchView('capture')">ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø·</button>
    <button class="tab" onclick="switchView('timeline')">ğŸ—“ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</button>
    <button class="tab" onclick="switchView('stats')">âœ¦ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
  </div>

  <!-- Capture View -->
  <div class="view active" id="view-capture">
    <div class="camera-box" id="cameraBox">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <img id="preview" alt="preview">
      <div class="camera-placeholder" id="placeholder">
        <div class="icon">â—</div>
        <p>Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>
      </div>
      <div class="camera-overlay">
        <div class="corner tl"></div>
        <div class="corner tr"></div>
        <div class="corner bl"></div>
        <div class="corner br"></div>
      </div>
    </div>

    <div id="camera-controls">
      <button class="btn-primary" onclick="startCamera()">ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    </div>

    <div id="capture-controls" style="display:none;">
      <button class="btn-primary" onclick="capturePhoto()">âœ¦ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù„Ø­Ø¸Ø©</button>
      <button class="btn-secondary" onclick="switchCamera()">âŸ² ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    </div>

    <div id="save-controls" style="display:none;">
      <label class="field-label">ÙƒÙŠÙ ØªØ´Ø¹Ø±ØŸ</label>
      <div class="mood-row" id="moodRow"></div>
      <textarea class="note-input" id="noteInput" rows="3" placeholder="ÙˆØ´ ÙÙŠ Ø¨Ø§Ù„Ùƒ Ø§Ù„Ø­ÙŠÙ†..."></textarea>
      <button class="btn-primary" onclick="saveEntry()">Ø­ÙØ¸ Ø§Ù„Ù„Ø­Ø¸Ø©</button>
      <button class="btn-secondary" onclick="retake()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø§Ø·</button>
    </div>
  </div>

  <!-- Timeline View -->
  <div class="view" id="view-timeline">
    <div id="timeline-list"></div>
  </div>

  <!-- Stats View -->
  <div class="view" id="view-stats">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-num" id="stat-total">0</div>
        <div class="stat-label">Ù„Ø­Ø¸Ø© Ù…Ø­ÙÙˆØ¸Ø©</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="stat-days">0</div>
        <div class="stat-label">ÙŠÙˆÙ… Ù…Ù† Ø§Ù„ØªÙÙƒÙŠØ±</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="stat-month">0</div>
        <div class="stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="stat-mood">â€”</div>
        <div class="stat-label">Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ø¹Ø±Ùƒ</div>
      </div>
    </div>
    <div class="stat-card" style="margin-bottom:12px; padding:20px;">
      <div class="stat-label" style="margin-bottom:12px;">Ø£ÙˆÙ„ Ù„Ø­Ø¸Ø©</div>
      <div id="stat-first" style="font-size:13px; color:var(--text); line-height:1.7;">â€”</div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IndexedDB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_NAME = 'laha_db';
const DB_VER = 1;
let db;

function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('entries')) {
        d.createObjectStore('entries', { keyPath: 'id', autoIncrement: true });
      }
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = e => rej(e);
  });
}

function dbGetAll() {
  return new Promise((res, rej) => {
    const tx = db.transaction('entries', 'readonly');
    const req = tx.objectStore('entries').getAll();
    req.onsuccess = e => res(e.target.result);
    req.onerror = rej;
  });
}

function dbAdd(entry) {
  return new Promise((res, rej) => {
    const tx = db.transaction('entries', 'readwrite');
    const req = tx.objectStore('entries').add(entry);
    req.onsuccess = e => res(e.target.result);
    req.onerror = rej;
  });
}

function dbDelete(id) {
  return new Promise((res, rej) => {
    const tx = db.transaction('entries', 'readwrite');
    const req = tx.objectStore('entries').delete(id);
    req.onsuccess = res;
    req.onerror = rej;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Camera
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let stream = null;
let facingMode = 'user';
let capturedBlob = null;

async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode, width: { ideal: 1080 }, height: { ideal: 1440 } },
      audio: false
    });
    const video = document.getElementById('video');
    video.srcObject = stream;
    video.style.display = 'block';
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('preview').style.display = 'none';
    document.getElementById('camera-controls').style.display = 'none';
    document.getElementById('capture-controls').style.display = 'block';
    document.getElementById('save-controls').style.display = 'none';
  } catch(e) {
    showToast('ØªØ¹Ø°Ù‘Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§');
  }
}

async function switchCamera() {
  facingMode = facingMode === 'user' ? 'environment' : 'user';
  if (stream) { stream.getTracks().forEach(t => t.stop()); }
  await startCamera();
}

function capturePhoto() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');

  // Mirror if front camera
  if (facingMode === 'user') {
    ctx.translate(canvas.width, 0);
    ctx.scale(-1, 1);
  }
  ctx.drawImage(video, 0, 0);

  // Watermark
  const now = new Date();
  const dateStr = now.toLocaleDateString('ar-SA', { year:'numeric', month:'long', day:'numeric' });
  const timeStr = now.toLocaleTimeString('ar-SA', { hour:'2-digit', minute:'2-digit' });
  ctx.setTransform(1,0,0,1,0,0);

  // subtle watermark bottom
  ctx.fillStyle = 'rgba(0,0,0,0.45)';
  ctx.fillRect(0, canvas.height - 60, canvas.width, 60);
  ctx.fillStyle = 'rgba(201,169,110,0.9)';
  ctx.font = `${canvas.width * 0.04}px Arial`;
  ctx.textAlign = 'left';
  ctx.fillText(`Ù„ÙÙ‡Ø§  Â·  ${dateStr}  ${timeStr}`, 20, canvas.height - 20);

  canvas.toBlob(blob => {
    capturedBlob = blob;
    const url = URL.createObjectURL(blob);
    const preview = document.getElementById('preview');
    preview.src = url;
    preview.style.display = 'block';
    video.style.display = 'none';

    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }

    document.getElementById('capture-controls').style.display = 'none';
    document.getElementById('save-controls').style.display = 'block';
  }, 'image/jpeg', 0.85);
}

function retake() {
  capturedBlob = null;
  document.getElementById('preview').style.display = 'none';
  document.getElementById('preview').src = '';
  document.getElementById('save-controls').style.display = 'none';
  document.getElementById('camera-controls').style.display = 'block';
  document.getElementById('placeholder').style.display = 'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Mood
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const moods = ['Ø³Ø¹ÙŠØ¯ ğŸ˜Š','Ù…Ù…ØªÙ† ğŸ¤','Ù…ØªØ­Ù…Ø³ âœ¨','Ù‡Ø§Ø¯Ø¦ ğŸŒ™','Ù…ØªÙÙƒØ± ğŸ’­','Ù…ØªØ¹Ø¨ ğŸ˜´','Ù…Ø´ØªØ§Ù‚ ğŸ’›'];
let selectedMood = moods[0];

function renderMoods() {
  const row = document.getElementById('moodRow');
  row.innerHTML = moods.map(m => `
    <div class="mood-chip ${m===selectedMood?'selected':''}" onclick="selectMood('${m}')">${m}</div>
  `).join('');
}

function selectMood(m) {
  selectedMood = m;
  renderMoods();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save & Display
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveEntry() {
  if (!capturedBlob) return showToast('Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');

  const reader = new FileReader();
  reader.onload = async () => {
    const entry = {
      image: reader.result,
      mood: selectedMood,
      note: document.getElementById('noteInput').value.trim(),
      date: new Date().toISOString()
    };
    await dbAdd(entry);
    capturedBlob = null;
    document.getElementById('noteInput').value = '';
    document.getElementById('preview').style.display = 'none';
    document.getElementById('save-controls').style.display = 'none';
    document.getElementById('camera-controls').style.display = 'block';
    document.getElementById('placeholder').style.display = 'flex';
    updateCounter();
    showToast('âœ¦ Ø­ÙÙØ¸Øª Ø§Ù„Ù„Ø­Ø¸Ø©');
  };
  reader.readAsDataURL(capturedBlob);
}

async function renderTimeline() {
  const all = await dbGetAll();
  const list = document.getElementById('timeline-list');
  if (all.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="icon">â—</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø­Ø¸Ø§Øª Ø¨Ø¹Ø¯<br>Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªÙ‚Ø§Ø· Ø£ÙˆÙ„ Ù„Ø­Ø¸Ø© Ù„Ù‡Ø§</p></div>`;
    return;
  }
  list.innerHTML = all.slice().reverse().map(e => {
    const d = new Date(e.date);
    const dateStr = d.toLocaleDateString('ar-SA', { year:'numeric', month:'long', day:'numeric', weekday:'long' });
    const timeStr = d.toLocaleTimeString('ar-SA', { hour:'2-digit', minute:'2-digit' });
    return `
      <div class="entry-card" data-id="${e.id}">
        <img class="entry-img" src="${e.image}" loading="lazy">
        <div class="entry-info">
          <div class="entry-date">${dateStr}  Â·  ${timeStr}</div>
          <div class="entry-mood">${e.mood}</div>
          ${e.note ? `<div class="entry-note">${e.note}</div>` : ''}
          <button class="entry-delete" onclick="deleteEntry(${e.id})">Ø­Ø°Ù</button>
        </div>
      </div>
    `;
  }).join('');
}

async function deleteEntry(id) {
  if (!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø­Ø¸Ø©ØŸ')) return;
  await dbDelete(id);
  updateCounter();
  renderTimeline();
  renderStats();
}

async function updateCounter() {
  const all = await dbGetAll();
  const n = all.length;
  document.getElementById('counter').textContent = `${n} Ù„Ø­Ø¸Ø© Ù…Ø­ÙÙˆØ¸Ø©`;
  return all;
}

async function renderStats() {
  const all = await dbGetAll();
  const now = new Date();

  document.getElementById('stat-total').textContent = all.length;

  // unique days
  const days = new Set(all.map(e => new Date(e.date).toDateString()));
  document.getElementById('stat-days').textContent = days.size;

  // this month
  const thisMonth = all.filter(e => {
    const d = new Date(e.date);
    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
  });
  document.getElementById('stat-month').textContent = thisMonth.length;

  // top mood
  const moodCount = {};
  all.forEach(e => { moodCount[e.mood] = (moodCount[e.mood] || 0) + 1; });
  const topMood = Object.entries(moodCount).sort((a,b) => b[1]-a[1])[0];
  document.getElementById('stat-mood').textContent = topMood ? topMood[0].split(' ')[1] || topMood[0] : 'â€”';

  // first entry
  if (all.length > 0) {
    const first = all[0];
    const d = new Date(first.date);
    const dateStr = d.toLocaleDateString('ar-SA', { year:'numeric', month:'long', day:'numeric' });
    document.getElementById('stat-first').textContent = `${dateStr}${first.note ? ` Â· "${first.note}"` : ''}`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`view-${name}`).classList.add('active');
  event.target.classList.add('active');

  if (name === 'timeline') renderTimeline();
  if (name === 'stats') renderStats();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
openDB().then(() => {
  updateCounter();
  renderMoods();
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
  }
});
</script>
</body>
</html>
