<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ù„Ù‡Ø§</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a0a0f">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ù„Ù‡Ø§">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --card: #1a1a26;
    --accent: #c9a96e;
    --accent2: #e8c99a;
    --text: #f0ead6;
    --muted: #6b6580;
    --border: rgba(201,169,110,0.15);
    --danger: #e07070;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  body { font-family:'Tajawal',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; }
  body::before {
    content:''; position:fixed; inset:0; pointer-events:none; z-index:0;
    background: radial-gradient(ellipse 60% 50% at 50% 0%,rgba(201,169,110,0.06) 0%,transparent 70%),
                radial-gradient(ellipse 40% 30% at 80% 80%,rgba(180,140,90,0.04) 0%,transparent 60%);
  }
  .app { position:relative; z-index:1; max-width:480px; margin:0 auto; padding-bottom:90px; }

  /* Header */
  .header { text-align:center; padding:44px 24px 28px; position:relative; }
  .header::after { content:''; position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:60px; height:1px; background:linear-gradient(90deg,transparent,var(--accent),transparent); }
  .ornament { font-size:22px; letter-spacing:8px; color:var(--accent); opacity:.6; margin-bottom:10px; }
  .header h1 { font-size:36px; font-weight:300; letter-spacing:4px; color:var(--accent2); margin-bottom:4px; }
  .header p { font-size:13px; color:var(--muted); font-weight:300; letter-spacing:1px; }
  #counter { display:inline-block; margin-top:14px; padding:5px 16px; border:1px solid var(--border); border-radius:20px; font-size:12px; color:var(--accent); letter-spacing:1px; }

  /* Tabs */
  .tabs { display:flex; margin:24px 16px 0; background:var(--surface); border-radius:12px; padding:4px; border:1px solid var(--border); gap:2px; }
  .tab { flex:1; padding:9px 4px; text-align:center; font-size:11px; font-family:'Tajawal',sans-serif; border:none; background:none; color:var(--muted); cursor:pointer; border-radius:9px; transition:all .25s; }
  .tab.active { background:var(--card); color:var(--accent2); box-shadow:0 2px 8px rgba(0,0,0,.4); }

  /* Views */
  .view { display:none; padding:16px; }
  .view.active { display:block; }

  /* Camera */
  .camera-box { position:relative; background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; aspect-ratio:3/4; display:flex; align-items:center; justify-content:center; margin-bottom:14px; }
  #video { width:100%; height:100%; object-fit:cover; display:none; transform:scaleX(-1); }
  #canvas { display:none; }
  #preview { width:100%; height:100%; object-fit:cover; display:none; border-radius:16px; }
  .camera-placeholder { text-align:center; color:var(--muted); flex-direction:column; display:flex; align-items:center; justify-content:center; gap:8px; }
  .camera-placeholder .icon { font-size:44px; opacity:.3; }
  .camera-placeholder p { font-size:13px; }
  .cam-overlay { position:absolute; inset:0; pointer-events:none; }
  .corner { position:absolute; width:18px; height:18px; border-color:var(--accent); border-style:solid; opacity:.5; }
  .corner.tl { top:14px; right:14px; border-width:2px 0 0 2px; }
  .corner.tr { top:14px; left:14px; border-width:2px 2px 0 0; }
  .corner.bl { bottom:14px; right:14px; border-width:0 0 2px 2px; }
  .corner.br { bottom:14px; left:14px; border-width:0 2px 2px 0; }

  /* Meta row (location/weather) */
  .meta-row { display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap; }
  .meta-chip { display:flex; align-items:center; gap:5px; padding:6px 12px; background:var(--surface); border:1px solid var(--border); border-radius:20px; font-size:11px; color:var(--muted); }
  .meta-chip.loaded { color:var(--accent2); border-color:rgba(201,169,110,0.3); }
  .meta-chip .spin { display:inline-block; animation:spin .8s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* Buttons */
  .btn-primary { width:100%; padding:15px; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#1a1000; border:none; border-radius:12px; font-size:15px; font-family:'Tajawal',sans-serif; font-weight:700; cursor:pointer; transition:all .2s; letter-spacing:1px; }
  .btn-primary:active { transform:scale(.97); opacity:.9; }
  .btn-secondary { width:100%; padding:12px; background:var(--surface); color:var(--accent); border:1px solid var(--border); border-radius:12px; font-size:13px; font-family:'Tajawal',sans-serif; cursor:pointer; transition:all .2s; margin-top:8px; }
  .btn-secondary:active { opacity:.7; }
  .btn-danger { background:rgba(224,112,112,0.1); border-color:rgba(224,112,112,0.3); color:var(--danger); }

  /* Mood */
  .mood-row { display:flex; gap:7px; margin:10px 0; flex-wrap:wrap; }
  .mood-chip { padding:6px 12px; background:var(--surface); border:1px solid var(--border); border-radius:20px; font-size:12px; font-family:'Tajawal',sans-serif; color:var(--muted); cursor:pointer; transition:all .2s; }
  .mood-chip.selected { background:rgba(201,169,110,0.15); border-color:var(--accent); color:var(--accent2); }

  /* Voice note */
  .voice-row { display:flex; gap:8px; align-items:center; margin:10px 0; }
  .voice-btn { flex:1; padding:11px; background:var(--surface); border:1px solid var(--border); border-radius:12px; font-size:13px; font-family:'Tajawal',sans-serif; color:var(--muted); cursor:pointer; transition:all .2s; display:flex; align-items:center; justify-content:center; gap:6px; }
  .voice-btn.recording { border-color:var(--danger); color:var(--danger); animation:pulse 1s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }
  audio { flex:2; height:36px; border-radius:8px; min-width:0; }
  audio::-webkit-media-controls-panel { background:var(--surface); }

  /* Note input */
  .note-input { width:100%; background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:13px; color:var(--text); font-size:14px; font-family:'Tajawal',sans-serif; resize:none; outline:none; transition:border-color .2s; margin:10px 0; line-height:1.6; }
  .note-input:focus { border-color:rgba(201,169,110,0.4); }
  .note-input::placeholder { color:var(--muted); }
  .field-label { font-size:11px; color:var(--muted); display:block; margin-bottom:5px; letter-spacing:1px; }

  /* Timeline */
  .entry-card { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; margin-bottom:18px; animation:fadeUp .4s ease forwards; }
  @keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
  .entry-img { width:100%; aspect-ratio:3/4; object-fit:cover; display:block; }
  .entry-info { padding:14px; }
  .entry-date { font-size:11px; color:var(--accent); letter-spacing:1px; margin-bottom:6px; }
  .entry-badges { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:8px; }
  .badge { display:inline-flex; align-items:center; gap:4px; padding:3px 10px; background:rgba(201,169,110,0.1); border-radius:10px; font-size:11px; color:var(--accent2); }
  .badge.weather { background:rgba(100,160,255,0.1); color:#a0c4ff; }
  .badge.location { background:rgba(100,220,150,0.1); color:#a0f0c0; }
  .entry-note { font-size:13px; color:var(--text); line-height:1.7; opacity:.85; margin-bottom:8px; }
  .entry-audio { width:100%; height:34px; border-radius:8px; margin-bottom:8px; }
  .entry-actions { display:flex; gap:8px; margin-top:10px; }
  .entry-btn { flex:1; padding:8px; background:var(--surface); border:1px solid var(--border); border-radius:8px; font-size:11px; font-family:'Tajawal',sans-serif; color:var(--muted); cursor:pointer; transition:all .2s; }
  .entry-btn:active { opacity:.7; }
  .entry-btn.del { border-color:rgba(224,112,112,0.2); color:rgba(224,112,112,0.6); }
  .entry-btn.del:active { color:var(--danger); }

  .empty-state { text-align:center; padding:60px 20px; color:var(--muted); }
  .empty-state .icon { font-size:44px; margin-bottom:14px; opacity:.3; }
  .empty-state p { font-size:14px; line-height:1.8; }

  /* Map */
  #map { height:380px; border-radius:14px; overflow:hidden; border:1px solid var(--border); margin-bottom:14px; }
  #map .leaflet-container { background:#12121a; }

  /* Stats */
  .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:14px; }
  .stat-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px 14px; text-align:center; }
  .stat-num { font-size:34px; font-weight:300; color:var(--accent2); line-height:1; margin-bottom:5px; }
  .stat-label { font-size:11px; color:var(--muted); letter-spacing:1px; }

  /* Export */
  .export-section { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin-top:14px; }
  .export-title { font-size:13px; color:var(--accent); margin-bottom:12px; letter-spacing:1px; }

  /* Toast */
  .toast { position:fixed; bottom:95px; left:50%; transform:translateX(-50%); background:var(--accent); color:#1a1000; padding:11px 22px; border-radius:24px; font-size:13px; font-family:'Tajawal',sans-serif; font-weight:700; z-index:999; opacity:0; transition:opacity .3s; pointer-events:none; white-space:nowrap; }
  .toast.show { opacity:1; }

  /* Progress */
  .progress-bar { width:100%; height:4px; background:var(--surface); border-radius:2px; overflow:hidden; margin:8px 0; display:none; }
  .progress-fill { height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:2px; transition:width .3s; }
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="ornament">â€” âœ¦ â€”</div>
    <h1>Ù„ÙÙ€Ù‡ÙÙ€Ø§</h1>
    <p>Ù„Ø­Ø¸Ø§ØªÙƒ Ù‚Ø¨Ù„ Ø£Ù† ØªÙ„ØªÙ‚ÙŠÙ‡Ø§</p>
    <div id="counter">Ù  Ù„Ø­Ø¸Ø© Ù…Ø­ÙÙˆØ¸Ø©</div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="switchView('capture',this)">ğŸ“¸ Ø§Ù„ØªÙ‚Ø§Ø·</button>
    <button class="tab" onclick="switchView('timeline',this)">ğŸ—“ Ø§Ù„Ø°Ø§ÙƒØ±Ø©</button>
    <button class="tab" onclick="switchView('map',this)">ğŸ—º Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
    <button class="tab" onclick="switchView('stats',this)">âœ¦ Ø¥Ø­ØµØ§Ø¡</button>
  </div>

  <!-- â”€â”€ Capture â”€â”€ -->
  <div class="view active" id="view-capture">
    <div class="camera-box" id="cameraBox">
      <video id="video" autoplay playsinline muted></video>
      <canvas id="canvas"></canvas>
      <img id="preview" alt="preview">
      <div class="camera-placeholder" id="placeholder">
        <div class="icon">â—</div>
        <p>Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</p>
      </div>
      <div class="cam-overlay">
        <div class="corner tl"></div><div class="corner tr"></div>
        <div class="corner bl"></div><div class="corner br"></div>
      </div>
    </div>

    <div id="camera-controls">
      <button class="btn-primary" onclick="startCamera()">ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    </div>

    <div id="capture-controls" style="display:none">
      <button class="btn-primary" onclick="capturePhoto()">âœ¦ Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù„Ø­Ø¸Ø©</button>
      <button class="btn-secondary" onclick="switchCamera()">âŸ² ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    </div>

    <div id="save-controls" style="display:none">
      <!-- Meta: location + weather -->
      <div class="meta-row">
        <div class="meta-chip" id="chip-loc">ğŸ“ <span id="loc-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...</span></div>
        <div class="meta-chip" id="chip-weather">ğŸŒ¤ <span id="weather-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ù‚Ø³...</span></div>
      </div>

      <label class="field-label">ÙƒÙŠÙ ØªØ´Ø¹Ø±ØŸ</label>
      <div class="mood-row" id="moodRow"></div>

      <!-- Voice note -->
      <label class="field-label">Ù…Ù„Ø§Ø­Ø¸Ø© ØµÙˆØªÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <div class="voice-row">
        <button class="voice-btn" id="voiceBtn" onclick="toggleRecording()">ğŸ™ ØªØ³Ø¬ÙŠÙ„</button>
        <audio id="audioPreview" controls style="display:none"></audio>
      </div>

      <textarea class="note-input" id="noteInput" rows="3" placeholder="ÙˆØ´ ÙÙŠ Ø¨Ø§Ù„Ùƒ Ø§Ù„Ø­ÙŠÙ†..."></textarea>

      <button class="btn-primary" onclick="saveEntry()">Ø­ÙØ¸ Ø§Ù„Ù„Ø­Ø¸Ø©</button>
      <button class="btn-secondary" onclick="saveToGallery()">â¬‡ Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙˆØ¯ÙŠÙˆ Ø£ÙŠØ¶Ø§Ù‹</button>
      <button class="btn-secondary" onclick="retake()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø§Ø·</button>
    </div>
  </div>

  <!-- â”€â”€ Timeline â”€â”€ -->
  <div class="view" id="view-timeline">
    <div id="timeline-list"></div>
  </div>

  <!-- â”€â”€ Map â”€â”€ -->
  <div class="view" id="view-map">
    <div id="map"></div>
    <p style="font-size:12px;color:var(--muted);text-align:center;margin-top:8px;">Ø§Ù„Ù„Ø­Ø¸Ø§Øª Ø§Ù„Ù„ÙŠ Ø³Ø¬Ù‘Ù„Øª ÙÙŠÙ‡Ø§ Ù…ÙˆÙ‚Ø¹Ùƒ</p>
  </div>

  <!-- â”€â”€ Stats â”€â”€ -->
  <div class="view" id="view-stats">
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-num" id="stat-total">0</div><div class="stat-label">Ù„Ø­Ø¸Ø© Ù…Ø­ÙÙˆØ¸Ø©</div></div>
      <div class="stat-card"><div class="stat-num" id="stat-days">0</div><div class="stat-label">ÙŠÙˆÙ… Ù…Ù† Ø§Ù„ØªÙÙƒÙŠØ±</div></div>
      <div class="stat-card"><div class="stat-num" id="stat-month">0</div><div class="stat-label">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</div></div>
      <div class="stat-card"><div class="stat-num" id="stat-mood">â€”</div><div class="stat-label">Ø£ÙƒØ«Ø± Ù…Ø´Ø§Ø¹Ø±Ùƒ</div></div>
    </div>
    <div class="stat-card" style="margin-bottom:14px;padding:18px;">
      <div class="stat-label" style="margin-bottom:10px;">Ø£ÙˆÙ„ Ù„Ø­Ø¸Ø©</div>
      <div id="stat-first" style="font-size:13px;color:var(--text);line-height:1.7;">â€”</div>
    </div>

    <!-- Export section -->
    <div class="export-section">
      <div class="export-title">ØªØµØ¯ÙŠØ± Ø§Ù„Ù„Ø­Ø¸Ø§Øª</div>
      <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
      <button class="btn-primary" onclick="exportPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± ÙƒÙ€ PDF</button>
      <button class="btn-secondary" onclick="exportVideo()">ğŸ ØªØµØ¯ÙŠØ± ÙƒÙÙŠØ¯ÙŠÙˆ Slideshow</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IndexedDB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_NAME = 'laha_db_v2', DB_VER = 2;
let db;

function openDB() {
  return new Promise((res,rej) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('entries'))
        d.createObjectStore('entries', { keyPath:'id', autoIncrement:true });
    };
    req.onsuccess = e => { db = e.target.result; res(db); };
    req.onerror = rej;
  });
}
const tx = (mode='readonly') => db.transaction('entries', mode).objectStore('entries');
const dbGetAll = () => new Promise((res,rej) => { const r=tx().getAll(); r.onsuccess=e=>res(e.target.result); r.onerror=rej; });
const dbAdd = e => new Promise((res,rej) => { const r=tx('readwrite').add(e); r.onsuccess=e2=>res(e2.target.result); r.onerror=rej; });
const dbDelete = id => new Promise((res,rej) => { const r=tx('readwrite').delete(id); r.onsuccess=res; r.onerror=rej; });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Date helper â€” Gregorian always
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtDate(d) {
  return d.toLocaleDateString('ar-SA-u-ca-gregory', { year:'numeric', month:'long', day:'numeric', weekday:'long' });
}
function fmtTime(d) {
  return d.toLocaleTimeString('ar-SA-u-ca-gregory', { hour:'2-digit', minute:'2-digit' });
}
function fmtShort(d) {
  return d.toLocaleDateString('ar-SA-u-ca-gregory', { year:'numeric', month:'long', day:'numeric' });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Camera
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let stream = null, facingMode = 'user', capturedBlob = null;

async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode, width:{ideal:1080}, height:{ideal:1440} }, audio:false });
    const v = document.getElementById('video');
    v.srcObject = stream; v.style.display = 'block';
    document.getElementById('placeholder').style.display = 'none';
    document.getElementById('preview').style.display = 'none';
    document.getElementById('camera-controls').style.display = 'none';
    document.getElementById('capture-controls').style.display = 'block';
    document.getElementById('save-controls').style.display = 'none';
  } catch(e) { showToast('ØªØ¹Ø°Ù‘Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§'); }
}

async function switchCamera() {
  facingMode = facingMode === 'user' ? 'environment' : 'user';
  if (stream) stream.getTracks().forEach(t=>t.stop());
  await startCamera();
}

function capturePhoto() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth; canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  if (facingMode === 'user') { ctx.translate(canvas.width,0); ctx.scale(-1,1); }
  ctx.drawImage(video,0,0);
  ctx.setTransform(1,0,0,1,0,0);

  // Watermark â€” Gregorian date
  const now = new Date();
  const stamp = `Ù„ÙÙ‡Ø§  Â·  ${fmtShort(now)}  ${fmtTime(now)}`;
  const fs = Math.round(canvas.width * 0.038);
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(0, canvas.height - fs*2.2, canvas.width, fs*2.2);
  ctx.fillStyle = 'rgba(201,169,110,0.92)';
  ctx.font = `${fs}px Arial`;
  ctx.textAlign = 'right';
  ctx.fillText(stamp, canvas.width - 18, canvas.height - fs*0.5);

  canvas.toBlob(blob => {
    capturedBlob = blob;
    const url = URL.createObjectURL(blob);
    const prev = document.getElementById('preview');
    prev.src = url; prev.style.display = 'block';
    document.getElementById('video').style.display = 'none';
    if (stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
    document.getElementById('capture-controls').style.display = 'none';
    document.getElementById('save-controls').style.display = 'block';
    fetchMeta();
  }, 'image/jpeg', 0.88);
}

function retake() {
  capturedBlob = null; audioBlob = null;
  document.getElementById('preview').src = '';
  document.getElementById('preview').style.display = 'none';
  document.getElementById('audioPreview').style.display = 'none';
  document.getElementById('audioPreview').src = '';
  document.getElementById('save-controls').style.display = 'none';
  document.getElementById('camera-controls').style.display = 'block';
  document.getElementById('placeholder').style.display = 'flex';
  currentLoc = null; currentWeather = null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save to Gallery
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveToGallery() {
  if (!capturedBlob) return showToast('Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
  const url = URL.createObjectURL(capturedBlob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `laha_${Date.now()}.jpg`;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast('â¬‡ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Geolocation + Weather
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentLoc = null, currentWeather = null;

function fetchMeta() {
  // Location
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(async pos => {
      const { latitude:lat, longitude:lng } = pos.coords;
      currentLoc = { lat, lng };
      // Reverse geocode via nominatim
      try {
        const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`);
        const j = await r.json();
        const city = j.address?.city || j.address?.town || j.address?.village || j.address?.county || '';
        const country = j.address?.country || '';
        document.getElementById('loc-text').textContent = city ? `${city}` : `${lat.toFixed(2)}, ${lng.toFixed(2)}`;
        document.getElementById('chip-loc').classList.add('loaded');
      } catch {
        document.getElementById('loc-text').textContent = `${lat.toFixed(3)}, ${lng.toFixed(3)}`;
        document.getElementById('chip-loc').classList.add('loaded');
      }
      // Weather via wttr.in (no API key needed)
      try {
        const w = await fetch(`https://wttr.in/${lat},${lng}?format=j1`);
        const wj = await w.json();
        const desc = wj.current_condition?.[0];
        if (desc) {
          const temp = desc.temp_C + 'Â°';
          const feel = desc.weatherDesc?.[0]?.value || '';
          currentWeather = { temp, feel };
          document.getElementById('weather-text').textContent = `${temp} Â· ${feel}`;
          document.getElementById('chip-weather').classList.add('loaded');
        }
      } catch {
        document.getElementById('weather-text').textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
      }
    }, () => {
      document.getElementById('loc-text').textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
      document.getElementById('weather-text').textContent = 'ØºÙŠØ± Ù…ØªØ§Ø­';
    });
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Voice Notes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mediaRecorder = null, audioChunks = [], audioBlob = null, isRecording = false;

async function toggleRecording() {
  const btn = document.getElementById('voiceBtn');
  const ap = document.getElementById('audioPreview');
  if (!isRecording) {
    try {
      const s = await navigator.mediaDevices.getUserMedia({ audio:true });
      audioChunks = [];
      mediaRecorder = new MediaRecorder(s);
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type:'audio/webm' });
        ap.src = URL.createObjectURL(audioBlob);
        ap.style.display = 'block';
        s.getTracks().forEach(t=>t.stop());
      };
      mediaRecorder.start();
      isRecording = true;
      btn.textContent = 'â¹ Ø¥ÙŠÙ‚Ø§Ù';
      btn.classList.add('recording');
    } catch { showToast('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†'); }
  } else {
    mediaRecorder.stop(); isRecording = false;
    btn.textContent = 'ğŸ™ ØªØ³Ø¬ÙŠÙ„'; btn.classList.remove('recording');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Mood
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const moods = ['Ø³Ø¹ÙŠØ¯ ğŸ˜Š','Ù…Ù…ØªÙ† ğŸ¤','Ù…ØªØ­Ù…Ø³ âœ¨','Ù‡Ø§Ø¯Ø¦ ğŸŒ™','Ù…ØªÙÙƒØ± ğŸ’­','Ù…ØªØ¹Ø¨ ğŸ˜´','Ù…Ø´ØªØ§Ù‚ ğŸ’›'];
let selectedMood = moods[0];
function renderMoods() {
  document.getElementById('moodRow').innerHTML = moods.map(m =>
    `<div class="mood-chip${m===selectedMood?' selected':''}" onclick="selectMood('${m}')">${m}</div>`
  ).join('');
}
function selectMood(m) { selectedMood = m; renderMoods(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Save Entry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveEntry() {
  if (!capturedBlob) return showToast('Ø§Ù„ØªÙ‚Ø· ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');
  const toBase64 = b => new Promise(res => { const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(b); });
  const imgData = await toBase64(capturedBlob);
  const audData = audioBlob ? await toBase64(audioBlob) : null;
  const entry = {
    image: imgData, audio: audData,
    mood: selectedMood,
    note: document.getElementById('noteInput').value.trim(),
    date: new Date().toISOString(),
    loc: currentLoc,
    weather: currentWeather
  };
  await dbAdd(entry);
  capturedBlob = null; audioBlob = null; currentLoc = null; currentWeather = null;
  document.getElementById('noteInput').value = '';
  document.getElementById('audioPreview').style.display = 'none';
  document.getElementById('audioPreview').src = '';
  document.getElementById('preview').style.display = 'none';
  document.getElementById('save-controls').style.display = 'none';
  document.getElementById('camera-controls').style.display = 'block';
  document.getElementById('placeholder').style.display = 'flex';
  document.getElementById('chip-loc').classList.remove('loaded');
  document.getElementById('chip-weather').classList.remove('loaded');
  document.getElementById('loc-text').textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...';
  document.getElementById('weather-text').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø·Ù‚Ø³...';
  await updateCounter();
  showToast('âœ¦ Ø­ÙÙØ¸Øª Ø§Ù„Ù„Ø­Ø¸Ø©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Timeline
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderTimeline() {
  const all = await dbGetAll();
  const list = document.getElementById('timeline-list');
  if (!all.length) {
    list.innerHTML = `<div class="empty-state"><div class="icon">â—</div><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø­Ø¸Ø§Øª Ø¨Ø¹Ø¯<br>Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„ØªÙ‚Ø§Ø· Ø£ÙˆÙ„ Ù„Ø­Ø¸Ø© Ù„Ù‡Ø§</p></div>`;
    return;
  }
  list.innerHTML = all.slice().reverse().map(e => {
    const d = new Date(e.date);
    const badges = [
      `<span class="badge">${e.mood}</span>`,
      e.weather ? `<span class="badge weather">ğŸŒ¤ ${e.weather.temp}</span>` : '',
      e.loc ? `<span class="badge location">ğŸ“ Ù„Ø­Ø¸Ø© Ù…Ø¤Ø±Ø´ÙØ©</span>` : ''
    ].join('');
    return `
      <div class="entry-card" data-id="${e.id}">
        <img class="entry-img" src="${e.image}" loading="lazy">
        <div class="entry-info">
          <div class="entry-date">${fmtDate(d)} Â· ${fmtTime(d)}</div>
          <div class="entry-badges">${badges}</div>
          ${e.note ? `<div class="entry-note">${e.note}</div>` : ''}
          ${e.audio ? `<audio class="entry-audio" controls src="${e.audio}"></audio>` : ''}
          <div class="entry-actions">
            <button class="entry-btn" onclick="downloadEntry(${e.id})">â¬‡ Ø­ÙØ¸</button>
            <button class="entry-btn del" onclick="deleteEntry(${e.id})">Ø­Ø°Ù</button>
          </div>
        </div>
      </div>`;
  }).join('');
}

async function downloadEntry(id) {
  const all = await dbGetAll();
  const e = all.find(x => x.id === id);
  if (!e) return;
  const a = document.createElement('a');
  a.href = e.image; a.download = `laha_${id}.jpg`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

async function deleteEntry(id) {
  if (!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø­Ø¸Ø©ØŸ')) return;
  await dbDelete(id);
  await updateCounter();
  renderTimeline(); renderStats(); renderMap();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Map
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let leafletMap = null;

async function renderMap() {
  const all = await dbGetAll();
  const withLoc = all.filter(e => e.loc);

  if (!leafletMap) {
    leafletMap = L.map('map', { zoomControl:true, attributionControl:false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      maxZoom:19
    }).addTo(leafletMap);
  }

  leafletMap.eachLayer(l => { if (l instanceof L.Marker || l instanceof L.CircleMarker) leafletMap.removeLayer(l); });

  if (!withLoc.length) {
    leafletMap.setView([24.7,46.7], 5);
    return;
  }

  const icon = L.divIcon({
    className:'',
    html:`<div style="width:14px;height:14px;background:#c9a96e;border-radius:50%;border:2px solid #e8c99a;box-shadow:0 0 8px rgba(201,169,110,0.6);"></div>`,
    iconSize:[14,14], iconAnchor:[7,7]
  });

  const bounds = [];
  withLoc.forEach(e => {
    const d = new Date(e.date);
    const marker = L.marker([e.loc.lat, e.loc.lng], { icon });
    marker.bindPopup(`
      <div style="font-family:Tajawal,sans-serif;direction:rtl;text-align:right;min-width:160px;background:#1a1a26;color:#f0ead6;border-radius:8px;padding:8px;">
        <img src="${e.image}" style="width:100%;border-radius:6px;margin-bottom:6px;">
        <div style="font-size:11px;color:#c9a96e;">${fmtDate(d)}</div>
        ${e.note ? `<div style="font-size:12px;margin-top:4px;">${e.note}</div>` : ''}
      </div>
    `, { maxWidth:200 });
    marker.addTo(leafletMap);
    bounds.push([e.loc.lat, e.loc.lng]);
  });

  leafletMap.fitBounds(bounds, { padding:[30,30], maxZoom:12 });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Stats
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderStats() {
  const all = await dbGetAll();
  const now = new Date();
  document.getElementById('stat-total').textContent = all.length;
  const days = new Set(all.map(e => new Date(e.date).toDateString()));
  document.getElementById('stat-days').textContent = days.size;
  const thisMonth = all.filter(e => { const d=new Date(e.date); return d.getMonth()===now.getMonth()&&d.getFullYear()===now.getFullYear(); });
  document.getElementById('stat-month').textContent = thisMonth.length;
  const mc = {}; all.forEach(e=>{ mc[e.mood]=(mc[e.mood]||0)+1; });
  const top = Object.entries(mc).sort((a,b)=>b[1]-a[1])[0];
  document.getElementById('stat-mood').textContent = top ? top[0].split(' ').slice(-1)[0] : 'â€”';
  if (all.length) {
    const first = all[0]; const d = new Date(first.date);
    document.getElementById('stat-first').textContent = `${fmtDate(d)}${first.note ? ` Â· "${first.note}"` : ''}`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Export PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportPDF() {
  const all = await dbGetAll();
  if (!all.length) return showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø­Ø¸Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
  showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù€ PDF...');
  setProgress(0, true);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'portrait', unit:'mm', format:'a4' });
  const W=210, H=297;

  for (let i=0; i<all.length; i++) {
    const e = all[i];
    if (i>0) doc.addPage();
    setProgress(Math.round((i/all.length)*90));

    // Background
    doc.setFillColor(10,10,15); doc.rect(0,0,W,H,'F');

    // Image (portrait crop center)
    try {
      const imgH = 160; const imgY = 20;
      doc.addImage(e.image, 'JPEG', 20, imgY, W-40, imgH, undefined, 'MEDIUM');
    } catch {}

    // Date
    const d = new Date(e.date);
    doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.setTextColor(201,169,110);
    doc.text(`${fmtDate(d)} Â· ${fmtTime(d)}`, W/2, 190, { align:'center' });

    // Mood
    doc.setFontSize(11); doc.setTextColor(232,201,154);
    doc.text(e.mood, W/2, 200, { align:'center' });

    // Location & weather
    const extras = [];
    if (e.loc) extras.push(`ğŸ“ ${e.loc.lat.toFixed(3)}, ${e.loc.lng.toFixed(3)}`);
    if (e.weather) extras.push(`ğŸŒ¤ ${e.weather.temp} Â· ${e.weather.feel}`);
    if (extras.length) {
      doc.setFontSize(8); doc.setTextColor(107,101,128);
      doc.text(extras.join('  '), W/2, 207, { align:'center' });
    }

    // Note
    if (e.note) {
      doc.setFontSize(10); doc.setTextColor(240,234,214);
      const lines = doc.splitTextToSize(e.note, W-50);
      doc.text(lines, W/2, 218, { align:'center' });
    }

    // Page number
    doc.setFontSize(8); doc.setTextColor(107,101,128);
    doc.text(`${i+1} / ${all.length}`, W/2, H-8, { align:'center' });
  }

  setProgress(100);
  doc.save(`Ù„Ù‡Ø§_${Date.now()}.pdf`);
  setTimeout(() => setProgress(0, false), 800);
  showToast('âœ¦ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù€ PDF');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Export Video (Slideshow)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function exportVideo() {
  const all = await dbGetAll();
  if (!all.length) return showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø­Ø¸Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
  if (!window.MediaRecorder) return showToast('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
  showToast('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...');
  setProgress(0, true);

  const W=720, H=960, FPS=30, SLIDE_SECS=3;
  const canvas = document.createElement('canvas');
  canvas.width=W; canvas.height=H;
  const ctx = canvas.getContext('2d');
  const stream2 = canvas.captureStream(FPS);
  const recorder = new MediaRecorder(stream2, { mimeType: MediaRecorder.isTypeSupported('video/webm;codecs=vp9') ? 'video/webm;codecs=vp9' : 'video/webm' });
  const chunks = [];
  recorder.ondataavailable = e => chunks.push(e.data);
  recorder.onstop = () => {
    const blob = new Blob(chunks, { type:'video/webm' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`Ù„Ù‡Ø§_${Date.now()}.webm`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(url);
    setProgress(0, false);
    showToast('âœ¦ ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
  };

  recorder.start();
  const totalFrames = all.length * SLIDE_SECS * FPS;
  let frameIndex = 0;

  const drawSlide = async (entry, progress) => {
    ctx.fillStyle = '#0a0a0f'; ctx.fillRect(0,0,W,H);
    const img = new Image();
    await new Promise(res => { img.onload=res; img.src=entry.image; });
    // Fit image with cover
    const scale = Math.max(W/img.width, (H*0.75)/img.height);
    const sw = img.width*scale, sh = img.height*scale;
    ctx.drawImage(img, (W-sw)/2, 0, sw, sh);
    // Gradient overlay bottom
    const grad = ctx.createLinearGradient(0, H*0.6, 0, H);
    grad.addColorStop(0,'rgba(10,10,15,0)'); grad.addColorStop(1,'rgba(10,10,15,0.95)');
    ctx.fillStyle=grad; ctx.fillRect(0,0,W,H);
    // Text
    const d = new Date(entry.date);
    ctx.textAlign='center';
    ctx.font=`300 28px Arial`; ctx.fillStyle='rgba(201,169,110,0.9)';
    ctx.fillText(fmtShort(d), W/2, H*0.78);
    ctx.font=`400 34px Arial`; ctx.fillStyle='rgba(240,234,214,0.9)';
    ctx.fillText(entry.mood, W/2, H*0.84);
    if (entry.note) {
      ctx.font=`300 22px Arial`; ctx.fillStyle='rgba(240,234,214,0.7)';
      ctx.fillText(entry.note.substring(0,50)+(entry.note.length>50?'â€¦':''), W/2, H*0.9);
    }
    // watermark
    ctx.font=`300 18px Arial`; ctx.fillStyle='rgba(201,169,110,0.4)';
    ctx.fillText('Ù„ÙÙ‡Ø§', W/2, H*0.96);
    // progress bar
    ctx.fillStyle='rgba(201,169,110,0.3)'; ctx.fillRect(0,H-4,W*progress,4);
  };

  let slideIdx = 0;
  const animate = async () => {
    if (slideIdx >= all.length) { recorder.stop(); return; }
    const framesPerSlide = SLIDE_SECS * FPS;
    const frameInSlide = frameIndex % framesPerSlide;
    if (frameInSlide === 0 || frameIndex === 0) await drawSlide(all[slideIdx], frameInSlide/framesPerSlide);
    // Fade in/out
    const alpha = frameInSlide < FPS*0.4 ? frameInSlide/(FPS*0.4) : frameInSlide > FPS*2.6 ? 1-(frameInSlide-FPS*2.6)/(FPS*0.4) : 1;
    // just update progress bar smoothly
    ctx.clearRect(0, H-4, W, 4);
    ctx.fillStyle='rgba(201,169,110,0.3)'; ctx.fillRect(0,H-4,W*(frameInSlide/framesPerSlide),4);

    frameIndex++;
    setProgress(Math.round((slideIdx/all.length)*100));
    if (frameInSlide === framesPerSlide-1) { slideIdx++; await drawSlide(all[slideIdx]||all[all.length-1], 1); }
    setTimeout(animate, 1000/FPS);
  };
  await drawSlide(all[0], 0);
  animate();
}

function setProgress(val, show) {
  const bar = document.getElementById('progressBar');
  if (show !== undefined) bar.style.display = show ? 'block' : 'none';
  document.getElementById('progressFill').style.width = val + '%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateCounter() {
  const all = await dbGetAll();
  document.getElementById('counter').textContent = `${all.length} Ù„Ø­Ø¸Ø© Ù…Ø­ÙÙˆØ¸Ø©`;
}

function showToast(msg) {
  const t = document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2400);
}

function switchView(name, btn) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(`view-${name}`).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name==='timeline') renderTimeline();
  if (name==='map') renderMap();
  if (name==='stats') renderStats();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
openDB().then(() => {
  updateCounter(); renderMoods();
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
});
</script>
</body>
</html>
